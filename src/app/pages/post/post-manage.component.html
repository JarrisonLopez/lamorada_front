<h2>Gestionar publicaciones</h2>

<p *ngIf="err" class="err">{{ err }}</p>
<p *ngIf="msg" class="ok">{{ msg }}</p>

<section class="new" *ngIf="isPsychologist; else noPerms">
  <h3>Nuevo artículo</h3>
  <form [formGroup]="form" (ngSubmit)="create()" class="form">
    <input formControlName="title" placeholder="Título" />
    <textarea formControlName="content" rows="5" placeholder="Contenido (máx. 5000)"></textarea>

    <label class="check">
      <input type="checkbox" formControlName="active" />
      Público (activo)
    </label>

    <div class="row">
      <button [disabled]="saving || form.invalid">{{ saving ? 'Creando…' : 'Crear' }}</button>
      <button type="button" class="ghost" (click)="form.reset({ title: '', content: '', active: true })">Limpiar</button>
    </div>
  </form>
</section>

<ng-template #noPerms>
  <p class="muted">Debes iniciar sesión como psicólogo para gestionar publicaciones.</p>
</ng-template>

<h3>Todos los artículos</h3>
<div *ngIf="loading">Cargando lista…</div>

<div *ngFor="let p of posts" class="card">
  <div class="card-header">
    <strong>{{ p.title }}</strong>
    <small *ngIf="p.created_at">{{ p.created_at | date : 'short' }}</small>
  </div>

  <p class="meta">Autor: <span class="author">{{ authorName(p) }}</span></p>

  <!-- Vista normal (no edición) -->
  <ng-container *ngIf="editingId !== p._id; else editBlock">
    <p class="content">{{ p.content }}</p>

    <div class="badges">
      <span class="badge" [class.on]="p.active" [class.off]="!p.active">
        {{ p.active ? 'Activo' : 'Inactivo' }}
      </span>
    </div>

    <div class="actions" *ngIf="isOwner(p)">
      <button type="button" (click)="startEdit(p)">Editar</button>
      <button type="button" class="danger" (click)="remove(p)">Eliminar</button>
    </div>
  </ng-container>

  <!-- Bloque de edición inline -->
  <ng-template #editBlock>
    <form [formGroup]="editForm" class="edit">
      <input formControlName="title" placeholder="Título" />
      <textarea formControlName="content" rows="5" placeholder="Contenido"></textarea>
      <div class="row">
        <button type="button" (click)="saveEdit(p)" [disabled]="editForm.invalid">Guardar</button>
        <button type="button" class="ghost" (click)="cancelEdit()">Cancelar</button>
      </div>
    </form>
  </ng-template>

  <!-- Debug opcional -->
  <div *ngIf="debug" class="debug">
    <small>ownerId: {{ ownerId(p) || '—' }}</small>
  </div>
</div>

<style>
  .err { color: #b00020; margin: 0.5rem 0; }
  .ok { color: #0a7a2f; margin: 0.5rem 0; }
  .muted, .debug small { color: #666; }
  .meta { color: #374151; margin: 4px 0 8px; }
  .author { font-weight: 600; }

  .form { display: grid; gap: 0.5rem; max-width: 720px; }
  .check { display: flex; gap: 0.5rem; align-items: center; }
  .row { display: flex; gap: 0.5rem; }

  button { padding: 0.5rem 0.75rem; border: 1px solid #0b66c3; background: #0b66c3; color: #fff; border-radius: 8px; cursor: pointer; }
  .ghost { background: #f5f5f5; border-color: #ccc; color: #333; }
  .danger { background: #b00020; border-color: #b00020; }

  .card { border: 1px solid #eee; border-radius: 10px; padding: 0.75rem; margin: 0.5rem 0; background: #f9f9f9; }
  .card-header { display: flex; justify-content: space-between; gap: 1rem; }
  .content { white-space: pre-wrap; margin: 0.25rem 0 0.5rem; }
  .badges { display: flex; gap: 0.5rem; align-items: center; margin: 8px 0; }
  .badge { padding: 0.15rem 0.5rem; border-radius: 999px; border: 1px solid #ddd; font-size: 0.8rem; }
  .badge.on { background: #e7f5ee; color: #0a7a2f; border-color: #bfe7cf; }
  .badge.off { background: #feecec; color: #b00020; border-color: #f5c8c8; }

  .actions { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
  .edit { display: grid; gap: 8px; }
  .edit input, .edit textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
  .debug { margin: 2px 0 8px; }
</style>
